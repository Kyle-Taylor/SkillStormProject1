<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockSmart | Dashboard</title>
  <link rel="icon" type="image/png" href="/images/stocksmartlogowithbackground.png">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #121212;
      color: #f1f1f1;
    }

    /* --- NAVBAR --- */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1e1e1e;
      padding: 15px 40px;
      border-bottom: 1px solid #2a2a2a;
      position: relative;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .navbar-left img { height: 30px; }
    .user-dropdown {
      position: relative;
      display: inline-block;
      cursor: pointer;
      color: #ccc;
      font-size: 0.9rem;
    }
    .user-dropdown:hover { color: #fff; }
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 45px;
      background-color: #1f1f1f;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      min-width: 150px;
      z-index: 10;
    }
    .dropdown-menu.show { display: block; }
    .dropdown-item {
      padding: 12px 16px;
      color: #ddd;
      cursor: pointer;
    }
    .dropdown-item:hover { background-color: #2a2a2a; }

    /* --- DASHBOARD CONTENT --- */
    .dashboard { padding: 30px 50px; }
    .dashboard h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 25px;
    }

    /* --- CARDS --- */
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }
    .card {
      background-color: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .card h3 {
      color: #ccc;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .card-value {
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
    }

    /* --- TABS --- */
    .tabs {
      display: flex;
      margin-top: 40px;
      border-bottom: 1px solid #2a2a2a;
    }
    .tab {
      padding: 12px 25px;
      cursor: pointer;
      background-color: #1a1a1a;
      color: #bbb;
      border-radius: 8px 8px 0 0;
      margin-right: 10px;
    }
    .tab.active { background-color: #2a2a2a; color: #fff; }

    /* --- SEARCH / BUTTONS / TABLES --- */
    .search { margin: 20px 0; }
    .search input {
      width: 250px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      background-color: #2b2b2b;
      color: #f1f1f1;
    }
    .actions { text-align: right; margin: 15px 0; }
    .btn {
      background-color: #0078ff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover { background-color: #3399ff; }
    .table-container { padding: 20px 0; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td { padding: 12px 15px; text-align: left; }
    th {
      background-color: #2a2a2a;
      color: #ccc;
      font-size: 0.9rem;
    }
    tr:nth-child(even) { background-color: #181818; }
    tr:hover { background-color: #242424; }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-left">
      <img src="/images/StockSmartLogo.png" alt="StockSmart Logo">
      <span>StockSmart</span>
    </div>
    <div class="navbar-right">
      <div class="user-dropdown" id="userDropdown">
        user@company.com ▾
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" onclick="window.location.href='/LandingPage'">Home</div>
          <div class="dropdown-item" onclick="logout()">Logout</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD CONTENT -->
  <div class="dashboard">
    <h1>Dashboard</h1>

    <div class="cards">
      <div class="card">
        <h3>Supply below minimum restock amount ⚠️</h3>
        <div class="card-value" id="lowStockValue">Loading...</div>
      </div>
      <div class="card"><h3>Overall supply inventory</h3><div class="card-value">5,123 <small>7% ▼</small></div></div>
      <div class="card"><h3>Warehouses Near Capacity ⚠️</h3><div class="card-value">2</div></div>
      <div class="card"><h3>Total Inventory Value</h3><div class="card-value">$1,200,000</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active">Restocking</div>
      <div class="tab">Warehouses</div>
      <div class="tab">Checkouts</div>
      <div class="tab">All Stock</div>
    </div>

    <!-- RESTOCK TABLE -->
    <div class="table-container" id="restockSection">
      <table id="restockTable">
        <thead>
          <tr>
            <th>Restock ID</th>
            <th>Item Restocked</th>
            <th>Amount Ordered</th>
            <th>Restock Date</th>
            <th>Ordered By</th>
          </tr>
        </thead>
        <tbody id="restockTableBody">
          <tr><td colspan="5" style="text-align:center;">Loading restock orders...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- WAREHOUSE TABLE -->
    <div class="table-container" id="warehouseSection" style="display:none;">
      <table id="warehouseTable">
        <thead>
          <tr>
            <th>Warehouse ID</th>
            <th>Location</th>
            <th>Total Supply</th>
            <th>Capacity</th>
          </tr>
        </thead>
        <tbody id="warehouseTableBody">
          <tr><td colspan="4" style="text-align:center;">Loading warehouses...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ============================== LOAD RESTOCK ORDERS ==============================
    async function loadRestockOrders() {
      try {
        const response = await fetch("/restocks");
        const restocks = await response.json();
        const body = document.getElementById("restockTableBody");
        body.innerHTML = "";

        if (!restocks.length) {
          body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No restock orders found.</td></tr>`;
          return;
        }

        restocks.forEach(order => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.restockId}</td>
            <td>${order.product?.productName || "Unknown Item"}</td>
            <td>${order.amount}</td>
            <td>${new Date(order.restockDate).toLocaleDateString()}</td>
            <td>${order.orderedBy || "N/A"}</td>
          `;
          body.appendChild(row);
        });
      } catch (error) {
        console.error("Error loading restock orders:", error);
        document.getElementById("restockTableBody").innerHTML =
          `<tr><td colspan="5" style="text-align:center;color:red;">Error loading data</td></tr>`;
      }
    }

    // ============================== LOAD WAREHOUSES ==============================
    async function loadWarehouses() {
      try {
        const response = await fetch("/warehouses");
        const warehouses = await response.json();
        const body = document.getElementById("warehouseTableBody");
        body.innerHTML = "";

        if (!warehouses.length) {
          body.innerHTML = `<tr><td colspan="4" style="text-align:center;">No warehouses found.</td></tr>`;
          return;
        }

        warehouses.forEach(w => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${w.warehouseId}</td>
            <td>${w.location}</td>
            <td>${w.totalSupply}</td>
            <td>${w.capacity || "N/A"}</td>
          `;
          body.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading warehouses:", err);
        document.getElementById("warehouseTableBody").innerHTML =
          `<tr><td colspan="4" style="text-align:center;color:red;">Error loading data</td></tr>`;
      }
    }

    // ============================== LOW STOCK COUNT ==============================
    async function loadLowStockCount() {
      try {
        const response = await fetch("/inventory/below-minimum");
        const items = await response.json();
        const count = items.length;
        document.getElementById("lowStockValue").innerHTML = `${count} <small>items</small>`;
      } catch (err) {
        console.error("Error fetching low-stock count:", err);
        document.getElementById("lowStockValue").innerHTML = `<span style="color:red;">Error</span>`;
      }
    }

    // ============================== LOGIN CHECK ==============================
    async function checkLogin() {
      try {
        const response = await fetch("/users/current-user");
        if (!response.ok) return (window.location.href = "/Login");
        const user = await response.json();
        const userLabel = document.getElementById("userDropdown").firstChild;
        userLabel.textContent = `${user.email} ▾`;
      } catch {
        window.location.href = "/Login";
      }
    }

    // ============================== LOGOUT ==============================
    async function logout() {
      await fetch("/users/logout", { method: "POST" });
      window.location.href = "/Login";
    }

    // ============================== INITIAL LOAD ==============================
    checkLogin();
    loadRestockOrders();
    loadLowStockCount();

    // ============================== DROPDOWN ==============================
    const dropdown = document.getElementById("userDropdown");
    const menu = document.getElementById("dropdownMenu");
    dropdown.addEventListener("click", () => menu.classList.toggle("show"));
    window.addEventListener("click", (e) => {
      if (!dropdown.contains(e.target)) menu.classList.remove("show");
    });

    // ============================== TAB SWITCHING ==============================
    const tabs = document.querySelectorAll(".tab");
    const restockSection = document.getElementById("restockSection");
    const warehouseSection = document.getElementById("warehouseSection");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        if (tab.textContent.includes("Warehouses")) {
          restockSection.style.display = "none";
          warehouseSection.style.display = "block";
          loadWarehouses();
        } else {
          warehouseSection.style.display = "none";
          restockSection.style.display = "block";
        }
      });
    });
  </script>
</body>
</html>
