<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockSmart | Dashboard</title>
  <link rel="icon" type="image/png" href="/images/stocksmartlogowithbackground.png">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #121212;
      color: #f1f1f1;
    }

    /* --- NAVBAR --- */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1e1e1e;
      padding: 15px 40px;
      border-bottom: 1px solid #2a2a2a;
      position: relative;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .navbar-left img { height: 30px; }
    .user-dropdown {
      position: relative;
      display: inline-block;
      cursor: pointer;
      color: #ccc;
      font-size: 0.9rem;
    }
    .user-dropdown:hover { color: #fff; }
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 45px;
      background-color: #1f1f1f;
      border: 1px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      min-width: 150px;
      z-index: 10;
    }
    .dropdown-menu.show { display: block; }
    .dropdown-item {
      padding: 12px 16px;
      color: #ddd;
      cursor: pointer;
    }
    .dropdown-item:hover { background-color: #2a2a2a; }

    /* --- DASHBOARD CONTENT --- */
    .dashboard { padding: 30px 50px; }
    .dashboard h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 25px;
    }

    /* --- CARDS --- */
    .cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }
    .card {
      background-color: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .card h3 {
      color: #ccc;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .card-value {
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
    }

    /* --- TABS --- */
    .tabs {
      display: flex;
      margin-top: 40px;
      border-bottom: 1px solid #2a2a2a;
    }
    .tab {
      padding: 12px 25px;
      cursor: pointer;
      background-color: #1a1a1a;
      color: #bbb;
      border-radius: 8px 8px 0 0;
      margin-right: 10px;
    }
    .tab.active { background-color: #2a2a2a; color: #fff; }

    /* --- SEARCH / BUTTONS / TABLES --- */
    .search { margin: 20px 0; }
    .search input {
      width: 250px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      background-color: #2b2b2b;
      color: #f1f1f1;
    }
    .actions { text-align: right; margin: 15px 0; }
    .btn {
      background-color: #0078ff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover { background-color: #3399ff; }
    .table-container { padding: 20px 0; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td { padding: 12px 15px; text-align: left; }
    th {
      background-color: #2a2a2a;
      color: #ccc;
      font-size: 0.9rem;
    }
    tr:nth-child(even) { background-color: #181818; }
    tr:hover { background-color: #242424; }

      .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  .modal-content {
    position: relative;
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    width: 600px;
  }
  .close-btn {
  position: relative;
  top: 10px;
  right: 15px;
  background: none;
  border: none;
  color: #ff4d4d;
  font-size: 1.6rem;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.1s ease, color 0.1s ease;
  }

  .close-btn:hover {
    color: #ff6666;
    transform: scale(1.15);
  }


  </style>
</head>

<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-left">
      <img src="/images/StockSmartLogo.png" alt="StockSmart Logo">
      <span>StockSmart</span>
    </div>
    <div class="navbar-right">
      <div class="user-dropdown" id="userDropdown">
        user@company.com ▾
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" onclick="window.location.href='/LandingPage'">Home</div>
          <div class="dropdown-item" onclick="logout()">Logout</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD CONTENT -->
  <div class="dashboard">
    <h1>Dashboard</h1>

    <div class="cards">
      <div class="card">
        <h3>Supply below minimum restock amount ⚠️</h3>
        <div class="card-value" id="lowStockValue">Loading...</div>
      </div>
      <div class="card"><h3>Overall supply inventory</h3><div class="card-value">5,123 <small>7% ▼</small></div></div>
      <div class="card"><h3>Warehouses Near Capacity ⚠️</h3><div class="card-value">2</div></div>
      <div class="card"><h3>Total Inventory Value</h3><div class="card-value">$1,200,000</div></div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active">Restocking</div>
      <div class="tab">Warehouses</div>
      <div class="tab">Checkouts</div>
      <div class="tab">All Stock</div>
    </div>

    <!-- RESTOCK TABLE -->
    <div class="table-container" id="restockSection">
      <div class="actions">
          <button class="btn" onclick="openRestockModal()">New Restock Order</button>
      </div>
      <table id="restockTable">
        <thead>
          <tr>
            <th>Restock ID</th>
            <th>Item Restocked</th>
            <th>Amount Ordered</th>
            <th>Restock Date</th>
            <th>Ordered By</th>
          </tr>
        </thead>
        <tbody id="restockTableBody">
          <tr><td colspan="5" style="text-align:center;">Loading restock orders...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- WAREHOUSE TABLE -->
    <div class="table-container" id="warehouseSection" style="display:none;">
      <table id="warehouseTable">
        <thead>
          <tr>
            <th>Warehouse Name</th>
            <th>Location</th>
            <th>Total Supply</th>
            <th>Capacity</th>
          </tr>
        </thead>
        <tbody id="warehouseTableBody">
          <tr><td colspan="4" style="text-align:center;">Loading warehouses...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

    <!-- RESTOCK MODAL -->
    <div id="restockModal" class="modal" onclick="closeModal(event)">
      <div class="modal-content" id="restockModalContent" onclick="event.stopPropagation();">
        <button class="close-btn" onclick="closeModal()" aria-label="Close">&times;</button>
        <h2>Select Warehouses</h2>
        <div id="warehouseList" style="margin-top:10px;">
        </div>
        <div style="text-align:right;margin-top:20px;">
          <button id="nextStepBtn" class="btn" disabled>Next →</button>
        </div>
      </div>
    </div>

      <div id="toast" style="
      display:none;
      position:fixed;
      bottom:25px;
      right:25px;
      background: blue;;
      color:#fff;
      padding:12px 18px;
      border-radius:6px;
      box-shadow:0 2px 10px rgb(110, 110, 110);
      font-size:0.9rem;
      z-index:2000;
    "></div>




  <script>
    // ============================== LOAD RESTOCK ORDERS ==============================
    async function loadRestockOrders() {
      try {
        const response = await fetch("/restocks");
        const restocks = await response.json();
        const body = document.getElementById("restockTableBody");
        body.innerHTML = "";

        if (!restocks.length) {
          body.innerHTML = `<tr><td colspan="5" style="text-align:center;">No restock orders found.</td></tr>`;
          return;
        }
        const reversedRestocks = [...restocks].reverse();

        reversedRestocks.forEach(order => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${order.restockId}</td>
            <td>${order.product?.productName || "Unknown Item"}</td>
            <td>${order.amount}</td>
            <td>${new Date(order.restockDate).toLocaleDateString()}</td>
            <td>${order.orderedBy || "N/A"}</td>
          `;
          body.appendChild(row);
        });
      } catch (error) {
        console.error("Error loading restock orders:", error);
        document.getElementById("restockTableBody").innerHTML =
          `<tr><td colspan="5" style="text-align:center;color:red;">Error loading data</td></tr>`;
      }
    }

    // ============================== LOAD WAREHOUSES ==============================
    async function loadWarehouses() {
      try {
        const response = await fetch("/warehouses");
        const warehouses = await response.json();
        const body = document.getElementById("warehouseTableBody");
        body.innerHTML = "";

        if (!warehouses.length) {
          body.innerHTML = `<tr><td colspan="4" style="text-align:center;">No warehouses found.</td></tr>`;
          return;
        }

        warehouses.forEach(w => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${w.name}</td>
            <td>${w.location}</td>
            <td>${w.totalSupply}</td>
            <td>${w.capacity || "N/A"}</td>
          `;
          body.appendChild(row);
        });
      } catch (err) {
        console.error("Error loading warehouses:", err);
        document.getElementById("warehouseTableBody").innerHTML =
          `<tr><td colspan="4" style="text-align:center;color:red;">Error loading data</td></tr>`;
      }
    }

    // ============================== LOW STOCK COUNT ==============================
    async function loadLowStockCount() {
      try {
        const response = await fetch("/inventory/below-minimum");
        const items = await response.json();
        const count = items.length;
        document.getElementById("lowStockValue").innerHTML = `${count} <small>items</small>`;
      } catch (err) {
        console.error("Error fetching low-stock count:", err);
        document.getElementById("lowStockValue").innerHTML = `<span style="color:red;">Error</span>`;
      }
    }

    // ============================== LOGIN CHECK ==============================
    let currentUserEmail = null;
    async function checkLogin() {
      try {
        const response = await fetch("/users/current-user");
        if (!response.ok) return (window.location.href = "/Login");
        const user = await response.json();
        currentUserEmail = user.email;
        const userLabel = document.getElementById("userDropdown").firstChild;
        userLabel.textContent = `${user.email} ▾`;
      } catch {
        window.location.href = "/Login";
      }
    }

    // ============================== LOGOUT ==============================
    async function logout() {
      await fetch("/users/logout", { method: "POST" });
      window.location.href = "/Login";
    }

    // ============================== INITIAL LOAD ==============================
    checkLogin();
    loadRestockOrders();
    loadLowStockCount();

    // ============================== DROPDOWN ==============================
    const dropdown = document.getElementById("userDropdown");
    const menu = document.getElementById("dropdownMenu");
    dropdown.addEventListener("click", () => menu.classList.toggle("show"));
    window.addEventListener("click", (e) => {
      if (!dropdown.contains(e.target)) menu.classList.remove("show");
    });

    // ============================== TAB SWITCHING ==============================
    const tabs = document.querySelectorAll(".tab");
    const restockSection = document.getElementById("restockSection");
    const warehouseSection = document.getElementById("warehouseSection");

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        if (tab.textContent.includes("Warehouses")) {
          restockSection.style.display = "none";
          warehouseSection.style.display = "block";
          loadWarehouses();
        } else {
          warehouseSection.style.display = "none";
          restockSection.style.display = "block";
        }
      });
    });

    // ============================== OPEN RESTOCK MODAL ==============================
    async function openRestockModal() {
      const modal = document.getElementById("restockModal");
      const modalContent = document.getElementById("restockModalContent");
      modal.style.display = "flex";

      try {
        const res = await fetch("/warehouses");
        const warehouses = await res.json();

        modalContent.innerHTML = `
          <button id="closeModalBtn" style="
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #ff4d4d;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
          ">&times;</button>

          <h2 style="margin-top: 0;">Select Warehouses</h2>

          <div style="margin-top:15px; overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; color:#ddd; font-size:0.9rem;">
              <thead>
                <tr style="background-color:#2a2a2a;">
                  <th style="padding:8px 10px; text-align:left;">Select</th>
                  <th style="padding:8px 10px; text-align:left;">Warehouse Name</th>
                  <th style="padding:8px 10px; text-align:left;">Location</th>
                  <th style="padding:8px 10px; text-align:right;">Total Stock</th>
                  <th style="padding:8px 10px; text-align:right;">Capacity</th>
                </tr>
              </thead>
              <tbody id="warehouseList">
                ${warehouses.map(w => `
                  <tr style="border-bottom:1px solid #333;">
                    <td style="padding:8px 10px;">
                      <input type="checkbox" name="warehouse" value="${w.warehouseId}">
                    </td>
                    <td style="padding:8px 10px;">${w.name || "N/A"}</td>
                    <td style="padding:8px 10px;">${w.location}</td>
                    <td style="padding:8px 10px; text-align:right;">${w.totalSupply}</td>
                    <td style="padding:8px 10px; text-align:right;">${w.capacity}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>

          <div style="text-align:right;margin-top:20px;">
            <button id="nextStepBtn" class="btn" disabled>Next →</button>
          </div>
        `;

        // Enable close button
        document.getElementById("closeModalBtn").addEventListener("click", () => {
          document.getElementById("restockModal").style.display = "none";
        });

        // Checkbox event handling
        const list = document.getElementById("warehouseList");
        const nextBtn = document.getElementById("nextStepBtn");

        list.querySelectorAll("input[type='checkbox']").forEach(cb => {
          cb.addEventListener("change", () => {
            const anySelected = Array.from(list.querySelectorAll("input:checked")).length > 0;
            nextBtn.disabled = !anySelected;
          });
        });

        nextBtn.addEventListener("click", () => loadProductSelection());
      } catch (err) {
        console.error("Error loading warehouses:", err);
        modalContent.innerHTML = `<p style="color:red;">Error loading warehouses.</p>`;
      }
    }


  // ============================== STEP 2: SELECT PRODUCT ==============================
    async function loadProductSelection() {
    const modalContent = document.getElementById("restockModalContent");
    const selectedWarehouses = Array.from(document.querySelectorAll("input[name='warehouse']:checked"))
      .map(cb => cb.value);

    const products = await (await fetch("/products")).json();

    modalContent.innerHTML = `
      <h2>Select Product</h2>
      <select id="productSelect" style="margin-top:10px;width:100%;padding:8px;">
        <option value="">-- Choose a product --</option>
        ${products.map(p => `<option value="${p.productId}">${p.productName}</option>`).join("")}
      </select>

      <div id="productDetails" style="margin-top:15px;color:#ddd;font-size:0.9rem;"></div>

      <div style="text-align:right;margin-top:20px;">
        <button id="backBtn" class="btn" style="background-color:#555;">← Back</button>
        <button id="submitRestockBtn" class="btn" disabled>Submit</button>
      </div>
    `;

    document.getElementById("backBtn").addEventListener("click", openRestockModal);

    const productSelect = document.getElementById("productSelect");
    const detailsDiv = document.getElementById("productDetails");
    const submitBtn = document.getElementById("submitRestockBtn");

    productSelect.addEventListener("change", async (e) => {
      const productId = e.target.value;
      detailsDiv.innerHTML = "";
      submitBtn.disabled = true;
      if (!productId) return;

      try {
        const res = await fetch(`/products/${productId}`);
        const product = await res.json();

        // Handle missing supplier object gracefully
        const supplier = product.supplier
          ? `${product.supplier.name} (${product.supplier.contactEmail || "No email"})`
          : "Unknown Supplier";

        // Render full details + input for amount
        detailsDiv.innerHTML = `
          <p><strong>Category:</strong> ${product.category || "N/A"}</p>
          <p><strong>Price per unit:</strong> $${product.price.toFixed(2)}</p>
          <p><strong>Supplier:</strong> ${supplier}</p>
          <label style="display:block;margin-top:10px;">
            <strong>Amount to Restock:</strong>
            <input type="number" id="restockAmount" min="1"
                  style="margin-left:8px;width:100px;padding:5px;background:#2a2a2a;color:#fff;border:none;border-radius:4px;">
          </label>
          <p style="margin-top:8px;">Total Cost: $<span id="totalCost">0.00</span></p>
        `;

        const price = product.price;
        const amountInput = document.getElementById("restockAmount");
        const totalCost = document.getElementById("totalCost");

        amountInput.addEventListener("input", () => {
          const amount = parseInt(amountInput.value || 0);
          totalCost.textContent = (price * amount).toFixed(2);
          submitBtn.disabled = amount <= 0;
        });

        submitBtn.onclick = async () => {
          const amount = parseInt(amountInput.value);
          if (amount <= 0) return showToast("Please enter a valid amount.");

          for (const wId of selectedWarehouses) {
            await fetch("/restocks/create_restock", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                warehouseId: wId,
                productId: productId,
                amount: amount,
                orderedBy: currentUserEmail
              })
            });
          }
          showToast("Restock order(s) created successfully!");
          closeModal();
          loadRestockOrders();
        };
      } catch (err) {
        console.error("Error loading product:", err);
        detailsDiv.innerHTML = `<p style="color:red;">Error loading product details.</p>`;
      }
    });


  }


  // ============================== CLOSE MODAL ==============================
  function closeModal(event) {
    if (event && event.target.id !== "restockModal") return;
    document.getElementById("restockModal").style.display = "none";
  }


  function showToast(message, duration = 2500) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", duration);
  }


  </script>
</body>
</html>
